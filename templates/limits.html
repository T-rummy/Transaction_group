{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-primary mb-4">🎯 Spending Limits</h1>
        <p class="text-xl text-secondary">Set and manage your budget limits with smart alerts</p>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="mb-8">
                {% for message in messages %}
                    <div class="alert alert-success fade-in">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Quick Actions -->
    <div class="flex gap-4 mb-8 justify-center">
        <a href="{{ url_for('set_limit') }}" class="btn btn-primary">
            ➕ Add New Limit
        </a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            📝 Add Transaction
        </a>
        <a href="{{ url_for('stats') }}" class="btn btn-secondary">
            📈 View Analytics
        </a>
    </div>

    <!-- Limits Overview -->
    <div class="card mb-8">
        <div class="card-header">
            <h3 class="card-title">📊 Limits Overview</h3>
            <p class="card-subtitle">{{ limits|length }} active spending limits</p>
        </div>
        
        {% if limits %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for limit in limits %}
                <div class="card fade-in">
                    <div class="card-header">
                        <div class="flex items-center justify-between">
                            <h4 class="card-title text-lg">
                                {% if limit.Category == 'Food' %}🍽️
                                {% elif limit.Category == 'Transportation' %}🚗
                                {% elif limit.Category == 'Shopping' %}🛍️
                                {% elif limit.Category == 'Entertainment' %}🎬
                                {% elif limit.Category == 'Bills' %}💳
                                {% elif limit.Category == 'Healthcare' %}🏥
                                {% elif limit.Category == 'Education' %}📚
                                {% elif limit.Category == 'Travel' %}✈️
                                {% else %}📦{% endif %}
                                {{ limit.Category }}
                            </h4>
                            <div class="flex gap-2">
                                <button onclick="editLimit('{{ limit.Category }}', {{ limit.Limit }}, {{ limit.Alert_Threshold }})" 
                                        class="btn btn-sm btn-secondary">
                                    ✏️ Edit
                                </button>
                                <form method="POST" action="{{ url_for('delete_limit', category=limit.Category) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this limit?')">
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        🗑️ Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">Monthly Limit:</span>
                            <span class="font-bold text-lg">${{ "%.2f"|format(limit.Limit|float) }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">Alert Threshold:</span>
                            <span class="font-semibold text-primary">{{ limit.Alert_Threshold }}%</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">Alert Amount:</span>
                            <span class="font-semibold text-warning">${{ "%.2f"|format((limit.Limit|float) * (limit.Alert_Threshold|float) / 100) }}</span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mt-4">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-secondary">Current Spending</span>
                                <span class="font-medium">$0.00 / ${{ "%.2f"|format(limit.Limit|float) }}</span>
                            </div>
                            <div class="w-full bg-secondary rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-tertiary mt-1">0% of limit used</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Test Alert Button -->
            <div class="text-center mt-8">
                <button onclick="testAlert()" class="btn btn-warning">
                    🚨 Test Website Alert
                </button>
                <p class="text-sm text-secondary mt-2">Test the spending alert system</p>
            </div>
        {% else %}
            <div class="text-center py-12">
                <div class="text-6xl mb-4">🎯</div>
                <h4 class="text-xl font-semibold mb-2">No spending limits set</h4>
                <p class="text-secondary mb-6">Set up spending limits to get notified when you approach your budget</p>
                <a href="{{ url_for('set_limit') }}" class="btn btn-primary">
                    ➕ Set Your First Limit
                </a>
            </div>
        {% endif %}
    </div>

    <!-- How It Works -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">💡 How Spending Limits Work</h3>
            <p class="card-subtitle">Understanding the alert system</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-4">
                <div class="text-3xl mb-3">🎯</div>
                <h4 class="font-semibold mb-2">Set Your Limits</h4>
                <p class="text-sm text-secondary">Define monthly spending limits for each category</p>
            </div>
            <div class="text-center p-4">
                <div class="text-3xl mb-3">📊</div>
                <h4 class="font-semibold mb-2">Track Spending</h4>
                <p class="text-sm text-secondary">Your expenses are automatically tracked against your limits</p>
            </div>
            <div class="text-center p-4">
                <div class="text-3xl mb-3">🚨</div>
                <h4 class="font-semibold mb-2">Get Alerts</h4>
                <p class="text-sm text-secondary">Receive notifications when you reach your threshold</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Limit Modal -->
<div id="editModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Edit Spending Limit</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('edit_limit') }}" class="space-y-4">
            <input type="hidden" id="editCategory" name="category">
            
            <div class="form-group">
                <label class="form-label">Category</label>
                <input type="text" id="editCategoryDisplay" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label">Monthly Limit ($)</label>
                <input type="number" step="0.01" id="editLimit" name="limit" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Alert Threshold (%)</label>
                <input type="number" min="1" max="100" id="editThreshold" name="alert_threshold" class="form-input" required>
                <p class="text-sm text-secondary mt-1">You'll be alerted when you reach this percentage of your limit</p>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" class="btn btn-primary flex-1">💾 Save Changes</button>
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary flex-1">❌ Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function editLimit(category, limit, threshold) {
    document.getElementById('editCategory').value = category;
    document.getElementById('editCategoryDisplay').value = category;
    document.getElementById('editLimit').value = limit;
    document.getElementById('editThreshold').value = threshold;
    
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

function testAlert() {
    fetch('{{ url_for("test_alert") }}')
        .then(response => {
            if (response.ok) {
                // The alert will be shown by the existing alert system
                console.log('Test alert triggered');
            }
        })
        .catch(error => {
            console.error('Error testing alert:', error);
        });
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});
</script>
{% endblock %}
