<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or "Budget Buddy" }}</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
</head>
<body>
    <!-- Spending Alerts -->
    <div id="spending-alerts" class="spending-alerts">
        <!-- Alerts will be dynamically inserted here -->
    </div>

    <!-- Modern Navigation -->
    <nav class="navbar">
        <div class="container">
            <!-- Brand -->
            <a href="{{ url_for('index') }}" class="nav-brand">
                <img src="{{ url_for('static', filename='images/budget-buddy-logo.png') }}" alt="Budget Buddy">
            </a>

            <!-- Desktop Navigation -->
            <ul class="nav-menu">
                <li><a href="{{ url_for('index') }}" class="nav-link {{ 'active' if request.endpoint == 'index' }}">Add Transaction</a></li>
                <li><a href="{{ url_for('transactions') }}" class="nav-link {{ 'active' if request.endpoint == 'transactions' }}">Transactions</a></li>
                <li><a href="{{ url_for('stats') }}" class="nav-link {{ 'active' if request.endpoint == 'stats' }}">Analytics</a></li>
                <li><a href="{{ url_for('achievements') }}" class="nav-link {{ 'active' if request.endpoint == 'achievements' }}">üèÜ Achievements</a></li>
                <li><a href="{{ url_for('limits') }}" class="nav-link {{ 'active' if request.endpoint == 'limits' }}">Limits</a></li>
                <li><a href="{{ url_for('scan_receipt') }}" class="nav-link {{ 'active' if request.endpoint == 'scan_receipt' }}">Scan Receipt</a></li>
            </ul>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                Menu
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="text-center">
                <p class="text-secondary">
                    ¬© 2025 Budget Buddy - Smart Expense Tracking
                </p>
            </div>
        </div>
    </footer>

    <!-- 3D Confetti Container -->
    <div id="confetti-3d-container" class="fixed inset-0 pointer-events-none z-50"></div>

    <!-- JavaScript -->
    <script>
        // 3D Confetti System
        class Confetti3D {
            constructor() {
                this.container = document.getElementById('confetti-3d-container');
                this.particles = [];
                this.colors = ['#3bac72', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
                this.shapes = ['üéâ', 'üéä', 'üèÜ', '‚≠ê', 'üíé', 'üåü', '‚ú®', 'üéØ'];
            }

            createParticle() {
                const particle = document.createElement('div');
                particle.className = 'confetti-3d-particle';
                
                // Random properties
                const color = this.colors[Math.floor(Math.random() * this.colors.length)];
                const shape = this.shapes[Math.floor(Math.random() * this.shapes.length)];
                const size = Math.random() * 20 + 15;
                const startX = Math.random() * window.innerWidth;
                const startY = -50;
                const endX = startX + (Math.random() - 0.5) * 400;
                const endY = window.innerHeight + 100;
                const rotation = Math.random() * 720;
                const duration = Math.random() * 3 + 2;
                const delay = Math.random() * 0.5;

                // Set styles
                particle.style.cssText = `
                    position: absolute;
                    left: ${startX}px;
                    top: ${startY}px;
                    font-size: ${size}px;
                    color: ${color};
                    transform: rotate(0deg);
                    animation: confetti3d-fall ${duration}s ${delay}s linear forwards;
                    z-index: ${Math.floor(Math.random() * 1000)};
                `;
                particle.textContent = shape;

                return particle;
            }

            create3DConfetti(count = 50) {
                // Clear existing confetti
                this.container.innerHTML = '';
                
                // Create new particles
                for (let i = 0; i < count; i++) {
                    const particle = this.createParticle();
                    this.container.appendChild(particle);
                    
                    // Remove particle after animation
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.remove();
                        }
                    }, 5000);
                }
            }
        }

        // Initialize 3D confetti
        const confetti3D = new Confetti3D();

        // Global function to trigger 3D confetti
        function trigger3DConfetti(count = 50) {
            confetti3D.create3DConfetti(count);
        }

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const menu = document.querySelector('.nav-menu');
            menu.classList.toggle('active');
        }

        // Spending Alerts System
        function fetchAlerts() {
            fetch('/get_alerts')
                .then(response => response.json())
                .then(alerts => {
                    const alertsContainer = document.getElementById('spending-alerts');
                    
                    if (alerts.length === 0) {
                        alertsContainer.classList.remove('show');
                        return;
                    }

                    alertsContainer.innerHTML = alerts.map(alert => `
                        <div class="spending-alert">
                            <div class="alert-content">
                                <div class="alert-title">Spending Alert: ${alert.category}</div>
                                <div class="alert-message">
                                    You've spent $${alert.current_spending} out of $${alert.limit} (${alert.threshold_percentage}% threshold)
                                </div>
                            </div>
                            <button class="alert-dismiss" onclick="dismissAlert('${alert.key}')">
                                √ó
                            </button>
                        </div>
                    `).join('');

                    alertsContainer.classList.add('show');
                })
                .catch(error => console.error('Error fetching alerts:', error));
        }

        function dismissAlert(alertKey) {
            fetch(`/dismiss_alert/${alertKey}`)
                .then(() => {
                    fetchAlerts();
                })
                .catch(error => console.error('Error dismissing alert:', error));
        }

        // Initialize alerts and refresh every 30 seconds
        fetchAlerts();
        setInterval(fetchAlerts, 30000);

        // Check for achievement flash messages and trigger confetti
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.alert');
            flashMessages.forEach(message => {
                if (message.textContent.includes('achievements unlocked')) {
                    setTimeout(() => {
                        trigger3DConfetti(100);
                    }, 500);
                }
            });
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add fade-in animation to cards
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.card, .stat-card').forEach(card => {
            observer.observe(card);
        });
    </script>

    <style>
        /* Additional styles for better UX */
        .main-content {
            min-height: calc(100vh - 200px);
            padding: var(--space-xl) 0;
        }

        .footer {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-primary);
            padding: var(--space-lg) 0;
            margin-top: auto;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Focus styles for accessibility */
        .nav-link:focus,
        .btn:focus,
        .form-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: var(--radius-md);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-secondary);
        }
    </style>
</body>
</html>
