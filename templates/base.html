<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or "Budget Buddy" }}</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
</head>
<body>
    <!-- Spending Alerts -->
    <div id="spending-alerts" class="spending-alerts">
        <!-- Alerts will be dynamically inserted here -->
    </div>

    <!-- Modern Navigation -->
    <nav class="navbar">
        <div class="container">
            <!-- Brand -->
            <a href="{{ url_for('index') }}" class="nav-brand">
                <img src="{{ url_for('static', filename='images/budget-buddy-logo.png') }}" alt="Budget Buddy">
            </a>

            <!-- Desktop Navigation -->
            <ul class="nav-menu">
                <li><a href="{{ url_for('index') }}" class="nav-link {{ 'active' if request.endpoint == 'index' }}">Add Transaction</a></li>
                <li><a href="{{ url_for('upload_receipt') }}" class="nav-link {{ 'active' if request.endpoint == 'upload_receipt' }}">üì∑ Upload Receipt</a></li>
                <li><a href="{{ url_for('transactions') }}" class="nav-link {{ 'active' if request.endpoint == 'transactions' }}">Transactions</a></li>
                <li><a href="{{ url_for('stats') }}" class="nav-link {{ 'active' if request.endpoint == 'stats' }}">Analytics</a></li>
                <li><a href="{{ url_for('achievements') }}" class="nav-link {{ 'active' if request.endpoint == 'achievements' }}">üèÜ Achievements</a></li>
                <li><a href="{{ url_for('limits') }}" class="nav-link {{ 'active' if request.endpoint == 'limits' }}">Limits</a></li>
                <li><a href="{{ url_for('qr_code') }}" class="nav-link {{ 'active' if request.endpoint == 'qr_code' }}">üì± QR Code</a></li>

            </ul>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="text-center">
                <p class="text-secondary">
                    ¬© 2025 Budget Buddy - Smart Expense Tracking
                </p>
            </div>
        </div>
    </footer>

    <!-- 3D Confetti Container -->
    <div id="confetti-3d-container" class="fixed inset-0 pointer-events-none z-50"></div>

    <!-- Cursor Trail Container -->
    <div id="cursor-trail" class="fixed inset-0 pointer-events-none z-40"></div>

    <!-- JavaScript -->
    <script>
        // 3D Confetti System
        class Confetti3D {
            constructor() {
                this.container = document.getElementById('confetti-3d-container');
                this.particles = [];
                this.colors = ['#3bac72', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
                this.shapes = ['üéâ', 'üéä', 'üèÜ', '‚≠ê', 'üíé', 'üåü', '‚ú®', 'üéØ'];
            }

            createParticle() {
                const particle = document.createElement('div');
                particle.className = 'confetti-3d-particle';
                
                // Random properties
                const color = this.colors[Math.floor(Math.random() * this.colors.length)];
                const shape = this.shapes[Math.floor(Math.random() * this.shapes.length)];
                const size = Math.random() * 20 + 15;
                const startX = Math.random() * window.innerWidth;
                // Vary the starting height for more natural shower effect
                const startY = -1000 - (Math.random() * 400); // Start between -1000 and -1400px
                const endX = startX + (Math.random() - 0.5) * 800; // More spread
                const endY = window.innerHeight + 300; // End further below
                const rotation = Math.random() * 720;
                const duration = Math.random() * 5 + 4; // Even longer duration
                const delay = Math.random() * 3; // More staggered timing

                // Set styles with better shower effect
                particle.style.cssText = `
                    position: fixed;
                    left: ${startX}px;
                    top: ${startY}px;
                    font-size: ${size}px;
                    color: ${color};
                    transform: rotate(0deg);
                    animation: confetti3d-shower ${duration}s ${delay}s linear forwards;
                    z-index: ${Math.floor(Math.random() * 1000)};
                    pointer-events: none;
                    user-select: none;
                    will-change: transform;
                `;
                particle.textContent = shape;

                return particle;
            }

            create3DConfetti(count = 50) {
                console.log('Creating 3D confetti, count:', count);
                console.log('Container:', this.container);
                
                // Clear existing confetti
                this.container.innerHTML = '';
                
                // Create new particles with varied timing for shower effect
                for (let i = 0; i < count; i++) {
                    const particle = this.createParticle();
                    this.container.appendChild(particle);
                    console.log('Added particle', i + 1, 'of', count);
                    
                    // Remove particle after animation (longer for shower effect)
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.remove();
                        }
                    }, 12000);
                }
                
                // Add some extra high-falling particles for dramatic effect
                for (let i = 0; i < Math.floor(count * 0.3); i++) {
                    setTimeout(() => {
                        const extraParticle = this.createParticle();
                        extraParticle.style.top = '-1600px'; // Start twice as high
                        this.container.appendChild(extraParticle);
                        
                        setTimeout(() => {
                            if (extraParticle.parentNode) {
                                extraParticle.remove();
                            }
                        }, 12000);
                    }, Math.random() * 2000); // Stagger the extra particles
                }
                
                console.log('Confetti creation complete');
            }
        }

        // Initialize 3D confetti
        const confetti3D = new Confetti3D();

        // Global function to trigger 3D confetti
        function trigger3DConfetti(count = 50) {
            console.log('Triggering 3D confetti with count:', count);
            if (confetti3D && confetti3D.container) {
                confetti3D.create3DConfetti(count);
                console.log('Confetti triggered successfully');
            } else {
                console.error('Confetti system not initialized properly');
            }
        }

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const menu = document.querySelector('.nav-menu');
            const hamburger = document.querySelector('.hamburger');
            menu.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        // Spending Alerts System
        function fetchAlerts() {
            fetch('/get_alerts')
                .then(response => response.json())
                .then(alerts => {
                    const alertsContainer = document.getElementById('spending-alerts');
                    
                    if (alerts.length === 0) {
                        alertsContainer.classList.remove('show');
                        return;
                    }

                    alertsContainer.innerHTML = alerts.map(alert => `
                        <div class="spending-alert">
                            <div class="alert-content">
                                <div class="alert-title">Spending Alert: ${alert.category}</div>
                                <div class="alert-message">
                                    You've spent $${alert.current_spending} out of $${alert.limit} (${alert.threshold_percentage}% threshold)
                                </div>
                            </div>
                            <button class="alert-dismiss" onclick="dismissAlert('${alert.key}')">
                                √ó
                            </button>
                        </div>
                    `).join('');

                    alertsContainer.classList.add('show');
                })
                .catch(error => console.error('Error fetching alerts:', error));
        }

        function dismissAlert(alertKey) {
            fetch(`/dismiss_alert/${alertKey}`)
                .then(() => {
                    fetchAlerts();
                })
                .catch(error => console.error('Error dismissing alert:', error));
        }

        // Initialize alerts and refresh every 30 seconds
        fetchAlerts();
        setInterval(fetchAlerts, 30000);

        // Cursor Trail Effect
        class CursorTrail {
            constructor() {
                this.container = document.getElementById('cursor-trail');
                this.particles = [];
                this.mouseX = 0;
                this.mouseY = 0;
                this.isMoving = false;
                this.colors = ['#3bac72', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
                this.init();
            }

            init() {
                document.addEventListener('mousemove', (e) => {
                    this.mouseX = e.clientX;
                    this.mouseY = e.clientY;
                    this.isMoving = true;
                    this.createParticle();
                });

                document.addEventListener('mouseleave', () => {
                    this.isMoving = false;
                });

                this.animate();
            }

            createParticle() {
                if (!this.isMoving) return;

                const particle = document.createElement('div');
                particle.className = 'cursor-particle';
                
                const color = this.colors[Math.floor(Math.random() * this.colors.length)];
                const size = Math.random() * 8 + 4;
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 2 + 1;
                
                particle.style.cssText = `
                    position: fixed;
                    left: ${this.mouseX}px;
                    top: ${this.mouseY}px;
                    width: ${size}px;
                    height: ${size}px;
                    background: ${color};
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    opacity: 0.8;
                    transform: translate(-50%, -50%);
                    animation: cursor-trail-fade 1s ease-out forwards;
                `;

                this.container.appendChild(particle);
                this.particles.push({
                    element: particle,
                    vx: Math.cos(angle) * velocity,
                    vy: Math.sin(angle) * velocity,
                    life: 1.0
                });

                // Remove old particles
                if (this.particles.length > 20) {
                    const oldParticle = this.particles.shift();
                    if (oldParticle.element.parentNode) {
                        oldParticle.element.parentNode.removeChild(oldParticle.element);
                    }
                }
            }

            animate() {
                this.particles.forEach((particle, index) => {
                    const rect = particle.element.getBoundingClientRect();
                    const x = rect.left + rect.width / 2;
                    const y = rect.top + rect.height / 2;
                    
                    particle.element.style.left = (x + particle.vx) + 'px';
                    particle.element.style.top = (y + particle.vy) + 'px';
                    
                    particle.life -= 0.02;
                    particle.element.style.opacity = particle.life;
                    
                    if (particle.life <= 0) {
                        if (particle.element.parentNode) {
                            particle.element.parentNode.removeChild(particle.element);
                        }
                        this.particles.splice(index, 1);
                    }
                });

                requestAnimationFrame(() => this.animate());
            }
        }

        // Initialize cursor trail
        document.addEventListener('DOMContentLoaded', function() {
            new CursorTrail();
        });

        // Achievement detection and confetti triggering
        document.addEventListener('DOMContentLoaded', function() {
            // Check for achievement flash messages
            const flashMessages = document.querySelectorAll('.alert');
            flashMessages.forEach(message => {
                const text = message.textContent.toLowerCase();
                if (text.includes('achievements unlocked') || text.includes('new achievements')) {
                    console.log('Achievement detected! Triggering confetti...');
                    setTimeout(() => {
                        trigger3DConfetti(100);
                    }, 800);
                }
            });

            // Also check for achievement page specifically
            if (window.location.pathname === '/achievements') {
                const unlockedCards = document.querySelectorAll('.achievement-card.unlocked');
                if (unlockedCards.length > 0) {
                    console.log('Achievement page with unlocked achievements detected!');
                    setTimeout(() => {
                        trigger3DConfetti(75);
                    }, 1000);
                }
            }

            // Listen for new flash messages (for dynamic content)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.classList && node.classList.contains('alert')) {
                            const text = node.textContent.toLowerCase();
                            if (text.includes('achievements unlocked') || text.includes('new achievements')) {
                                console.log('New achievement flash detected! Triggering confetti...');
                                setTimeout(() => {
                                    trigger3DConfetti(100);
                                }, 500);
                            }
                        }
                    });
                });
            });

            // Start observing
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add fade-in animation to cards
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.card, .stat-card').forEach(card => {
            observer.observe(card);
        });
    </script>

    <style>
        /* Additional styles for better UX */
        .main-content {
            min-height: calc(100vh - 200px);
            padding: var(--space-xl) 0;
        }

        .footer {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-primary);
            padding: var(--space-lg) 0;
            margin-top: auto;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Focus styles for accessibility */
        .nav-link:focus,
        .btn:focus,
        .form-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: var(--radius-md);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-secondary);
        }

        /* Secret dev button styles */
        .secret-dev-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(59, 172, 114, 0.1);
            border: 2px solid rgba(59, 172, 114, 0.3);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .secret-dev-button:hover {
            background: rgba(59, 172, 114, 0.2);
            border-color: rgba(59, 172, 114, 0.5);
            transform: scale(1.1);
        }

        .secret-dev-button.show {
            display: flex;
        }
    </style>

    <!-- Secret Dev Button -->
    <div id="secret-dev-button" class="secret-dev-button" onclick="window.location.href='/dev/test_achievements'">
        üîß
    </div>

    <script>
        // Secret dev button functionality
        let clickCount = 0;
        let clickTimer = null;
        const secretButton = document.getElementById('secret-dev-button');

        function handleSecretClick() {
            clickCount++;
            
            if (clickTimer) {
                clearTimeout(clickTimer);
            }
            
            clickTimer = setTimeout(() => {
                if (clickCount >= 3) {
                    secretButton.classList.add('show');
                    // Hide after 10 seconds
                    setTimeout(() => {
                        secretButton.classList.remove('show');
                        clickCount = 0;
                    }, 10000);
                } else {
                    clickCount = 0;
                }
            }, 1000); // Reset after 1 second
        }

        // Listen for clicks anywhere on the page
        document.addEventListener('click', handleSecretClick);
    </script>
</body>
</html>
